#!/bin/bash

set -euo pipefail
cd "$(dirname "$0")"

if [[ $# -eq 0 ]]; then
	echo "Usage: SERVICE ..." >&2
	echo "Where SERVICE is one of: borg mysql" >&2
	exit 1
fi

install_service() {
	local service_name="$1"
	local command="$2"

	install -v /dev/stdin /etc/systemd/system/$service_name.service <<-EOF
		[Service]
		Type=oneshot
		ExecStart=$PWD/$command
	EOF

	install -v /dev/stdin /etc/systemd/system/$service_name.timer <<-EOF
		[Timer]
		OnCalendar=daily
		RandomizedDelaySec=4h

		[Install]
		WantedBy=timers.target
	EOF

	systemctl daemon-reload
	systemctl enable $service_name.timer
	systemctl restart $service_name.timer
	systemctl status $service_name.timer
}

ensure_command() {
	local command="$1"
	local package="${2:-$1}"

	if ! command -v "$command" &>/dev/null; then
		apt-get install -t "$(lsb_release -cs)-backports" "$package"
	fi
}

ret=0

while [[ $# -gt 0 ]]; do
	service="$1"
	shift

	if [[ $service = borg ]]; then
		ensure_command borg borgbackup
		install_service borg-backup borg_backup
	elif [[ $service = mysql ]]; then
		ensure_command zstd
		install_service mysql-backup mysql_backup
	else
		echo "Unknown service: $service" >&2
		ret=1
	fi
done

exit $ret
