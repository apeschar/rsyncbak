#!/bin/bash

set -euo pipefail
cd "$(dirname "$0")/.."

source "etc/rsync_backup.defaults"
source "etc/rsync_backup"

remote="${dest%%:*}"
dir="${dest#*:}"
if [[ $dir != "" ]]; then
    dir="$dir/"
fi

bin/rsync-no-vanished \
    -e 'ssh -oConnectTimeout=10 -oConnectionAttempts=5' \
    $rsync_opts \
    -a --numeric-ids --rsync-path="rsync --fake-super" \
    --delete --delete-excluded \
    --one-file-system \
    --exclude-from etc/rsync_exclude \
    / "${dest}mirror/"

ssh "$remote" "touch ${dir}mirror.ok"
