#!/usr/bin/env bash

set -euo pipefail
cd "$(dirname "$0")/.."

source "etc/rsync_backup.defaults"
source "etc/rsync_backup"

remote="${dest%%:*}"

if [[ $# -ne 1 ]]; then
	echo "Usage: $0 <name>"
fi

name="$1"
file="log/$name.$(TZ=UTC date +%Y-%m-%dT%H:%M:%SZ).log.gz"

tee_tty() {
	if [[ -t 2 ]]; then
		tee >(cat >&2)
	else
		cat
	fi
}

mkdir -p log

tee_tty | gzip > "$file"

rsync "$file" "$remote:$name.log.gz"

find log -name "$name.*.log.gz" -type f -mtime +7 -delete
