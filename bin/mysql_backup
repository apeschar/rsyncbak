#!/bin/bash

set -euo pipefail
app="$(dirname "$0")/.."

source "$app/etc/rsync_backup.defaults"
source "$app/etc/rsync_backup"

if [[ -t 1 ]] && command -v pv &>/dev/null; then
    _pv() { pv "$@"; }
else
    _pv() { cat; }
fi

fail=0

remote="${dest%%:*}"
dir="${dest#*:}"
if [[ $dir != "" ]]; then
    dir="$dir/"
fi

IFS=$'\n' dbs=($(mysql -e 'show databases' --skip-column-names))

ssh "$remote" "$(printf 'mkdir -p %q' "${dir}mysql")"

for db in "${dbs[@]}"; do
    [[ $db = "performance_schema" ]] && continue
    [[ $db = "information_schema" ]] && continue
    path="${dir}mysql/${db}.sql.gz"
    tmp="${dir}mysql/${db}.sql.gz.$$.tmp"
    if mysqldump --single-transaction --routines --events "$db" |
         _pv -N "$db" | gzip | ssh "$remote" "$(printf 'dd of=%q status=none' "$tmp")"; then
        if ssh "$remote" "$(printf 'mv %q %q' "$tmp" "$path")"; then
            continue
        fi
    fi
    ssh "$remote" "$(printf 'rm -f %q' "$tmp")" || true
    fail=1
done

if [[ $fail -eq 0 ]]; then
    ssh "$remote" "$(printf 'touch %q' "${dir}mysql.ok")" || fail=1
fi

if [[ $fail -eq 1 ]]; then
    exit 1
fi
